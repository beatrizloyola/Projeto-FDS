{% extends "base.html" %}

{% block content %}
<div class="perfil-tabs">
        <a href="{% url 'atividade' %}">Atividade</a>
        <a href="{% url 'usuario' %}" class="active">UsuÃ¡rio</a>
</div>

<div class="container perfil-usuario">
    <div class="perfil-header">
                <div class="perfil-foto">
                        <form id="foto-form" method="post" action="{% url 'usuario' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="upload_foto" />
                                <label for="foto-input" class="foto-label">
                                    {% if perfil.foto %}
                                        <img id="perfil-img" src="{{ perfil.foto.url }}" alt="Foto do usuÃ¡rio" />
                                    {% else %}
                                        <div id="perfil-img" class="placeholder-foto"></div>
                                    {% endif %}
                                    <input id="foto-input" type="file" name="foto" accept="image/*" />
                                    <span class="camera-overlay" aria-hidden="true">ðŸ“·</span>
                                </label>
                        </form>
                </div>
        <div class="perfil-info">
            <h1>{{ request.user.get_full_name|default:request.user.username }}</h1>
            <p>Idade: {% if idade is not None %}{{ idade }} anos{% else %}â€”{% endif %}</p>
            <p>Peso: {% if peso %}{{ peso }} kg{% else %}â€”{% endif %}</p>
            <p>Altura: {% if altura %}{{ altura }} m{% else %}â€”{% endif %}</p>
            <p>Tempo de uso: {% if tempo_de_uso is not None %}{{ tempo_de_uso }} dias{% else %}â€”{% endif %}</p>
        </div>
    </div>
    <div class="perfil-actions">
        <a class="btn" href="{% url 'editar_usuario' %}"> Editar InformaÃ§Ãµes</a>
        <a class="btn" href="{% url 'password_change' %}"> Mudar a senha do UsuÃ¡rio</a>
        <a class="btn" href="{% url 'logout' %}"> Sair</a>
    </div>

    <div class="perfil-controls">
        <form method="post" action="{% url 'usuario' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="salvar_meta" />

            <div class="control-box">
                <div class="control-accent"></div>
                <div class="control-body">
                    <label>NotificaÃ§Ãµes</label>
                    <input id="notificacao-input" type="time" name="notificacao_horario" value="{% if perfil.notificacao_horario %}{{ perfil.notificacao_horario|time:"H:i" }}{% else %}15:00{% endif %}" />
                </div>
            </div>

            <div class="control-box">
                <div class="control-accent"></div>
                <div class="control-body">
                    <label>Meta de calorias:</label>
                    <input type="number" name="meta_calorias" value="{% if perfil.meta_calorias %}{{ perfil.meta_calorias }}{% else %}21000{% endif %}" />
                </div>
            </div>

            <div style="margin-top:10px">
                <button class="btn" type="submit">Salvar</button>
            </div>
        </form>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const input = document.getElementById('foto-input');
    const form = document.getElementById('foto-form');
    const img = document.getElementById('perfil-img');
    if (!input) return;
    const label = document.querySelector('.foto-label');
    input.addEventListener('change', function(e){
        const file = this.files && this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(ev){
                if (img.tagName.toLowerCase() === 'img') {
                    img.src = ev.target.result;
                } else {
                    const newImg = document.createElement('img');
                    newImg.id = 'perfil-img';
                    newImg.src = ev.target.result;
                    newImg.alt = 'Foto do usuÃ¡rio';
                    newImg.style.width = '100%';
                    newImg.style.height = '100%';
                    newImg.style.objectFit = 'cover';
                    newImg.style.objectPosition = 'center';
                    newImg.style.borderRadius = '50%';
                    newImg.style.display = 'block';
                    img.replaceWith(newImg);
                }
            };
            reader.readAsDataURL(file);
            form.submit();
        }
    });
    if (label) {
        label.setAttribute('tabindex', '0');
        label.setAttribute('role', 'button');


        label.addEventListener('keydown', function(e){
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                try { input.click(); } catch(err) { /* ignore */ }
            }
        });
    }
});
</script>
<script>
(function(){
    const notifInput = document.getElementById('notificacao-input');
    if (!notifInput) return;
    if (!('Notification' in window)) {
        console.log('Notifications not supported in this browser');
        return;
    }

    let notifTimer = null;

    function computeDelayForTime(timeStr) {
        try {
            const parts = timeStr.split(':').map(s => parseInt(s, 10));
            if (parts.length < 2 || isNaN(parts[0]) || isNaN(parts[1])) return null;
            const now = new Date();
            const next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parts[0], parts[1], 0, 0);
            if (next <= now) next.setDate(next.getDate() + 1);
            return next - now;
        } catch (err) {
            return null;
        }
    }

    function scheduleFromInput() {
        if (notifTimer) {
            clearTimeout(notifTimer);
            notifTimer = null;
        }
        const timeStr = notifInput.value;
        if (!timeStr) return;
        const delay = computeDelayForTime(timeStr);
        if (delay === null) return;
        // ensure permission
        if (Notification.permission !== 'granted') {
            Notification.requestPermission().then(function(result){
                if (result === 'granted') scheduleFromInput();
            });
            return;
        }

        notifTimer = setTimeout(function(){
            try {
                new Notification('Hora de treinar!', { body: 'Hora de treinar! Ã‰ hora de completar seu treino.' });
            } catch (err) {
                console.warn('Failed to show notification', err);
            }
            scheduleFromInput();
        }, delay);
        console.log('Scheduled notification in', delay, 'ms (for', timeStr, ')');
    }

    try {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(function(result){
                if (result === 'granted') scheduleFromInput();
            });
        } else if (Notification.permission === 'granted') {
            scheduleFromInput();
        }
    } catch (err) {
        console.warn('Notification setup error', err);
    }

    notifInput.addEventListener('change', function(){
        scheduleFromInput();
    });

})();
</script>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="perfil-tabs">
  <a href="{% url 'atividade' %}" class="active">Atividade</a>
  <a href="{% url 'usuario' %}">Usuário</a>
</div>

<div class="container">

  <div class="grafico-box">
    <h3>Dias Treinados</h3>
    <canvas id="graficoTreinos" height="140"></canvas>
    <div class="filtros">
      <button type="button" class="tab-btn" data-chart="mensal">Mensal</button>
      <button type="button" class="tab-btn" data-chart="anual">Anual</button>
    </div>
    {% if not grafico_mensal_values and not grafico_anual_values %}
      <p style="font-size:0.85rem;color:#666;">Sem registros de treinos para gerar gráfico.</p>
    {% endif %}
  </div>

  <div class="painel">
    <div class="objetivo-box">
      <h3>Objetivo</h3>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="acao" value="atualizar_objetivo">

        <div class="objetivo-opcoes">
          <label class="objetivo-item {% if perfil.objetivo == 'GANHO' %}ativo{% endif %}">
            <input type="radio" name="objetivo" value="GANHO" {% if perfil.objetivo == 'GANHO' %}checked{% endif %}>
            Ganhar massa magra
          </label>

          <label class="objetivo-item {% if perfil.objetivo == 'PERDA' %}ativo{% endif %}">
            <input type="radio" name="objetivo" value="PERDA" {% if perfil.objetivo == 'PERDA' %}checked{% endif %}>
            Perder peso
          </label>

          <label class="objetivo-item {% if perfil.objetivo == 'MANUT' %}ativo{% endif %}">
            <input type="radio" name="objetivo" value="MANUT" {% if perfil.objetivo == 'MANUT' %}checked{% endif %}>
            Manter peso
          </label>
        </div>
        <button type="submit" class="btn-salvar">Salvar</button>
      </form>
    </div>

  <div class="imc-box">
    <h3>IMC</h3>
    {% if msg %}
      <p>{{ msg }}</p>
    {% else %}
      <div class="imc-resultado">
  <p>Altura: {% if altura_m_display %}{{ altura_m_display }}{% else %}{{ perfil.altura_m }}{% endif %} m</p>
  <p>Peso: {% if peso_kg_display %}{{ peso_kg_display }}{% else %}{{ perfil.peso_kg }}{% endif %} kg</p>
        <p>
          Resultado:
          {% if imc %}
            {{ imc|floatformat:1 }} {% if classificacao_imc %} ({{ classificacao_imc }}){% endif %}
          {% else %}
            —
          {% endif %}
        </p>
        {% if gasto_calorico %}
          <p>Gasto calórico diário médio: {{ gasto_calorico }} kcal</p>
        {% endif %}
        {% if agua_recomendada %}
          <p>Consumo de água recomendado: {{ agua_recomendada }} L/dia</p>
        {% endif %}
      </div>
    {% endif %}
  </div>


  {% if msg %}
    <div class="mensagem">{{ msg }}</div>
  {% endif %}

</div>

{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/grafico_atividade.css' %}">
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  window.__GRAFICO__ = {
    mensalLabels: {{ grafico_mensal_labels|default:'[]'|safe }},
    mensalValues: {{ grafico_mensal_values|default:'[]'|safe }},
    anualLabels: {{ grafico_anual_labels|default:'[]'|safe }},
    anualValues: {{ grafico_anual_values|default:'[]'|safe }}
  };
</script>
<script src="{% static 'js/grafico_atividade.js' %}"></script>
<script>
  (function(){
    const container = document.querySelector('.objetivo-opcoes');
    if (!container) return;
    container.addEventListener('click', function(ev){
      const label = ev.target.closest('.objetivo-item');
      if (!label) return;
      document.querySelectorAll('.objetivo-item').forEach(function(l){ l.classList.remove('ativo'); });
      label.classList.add('ativo');
      const r = label.querySelector('input[type="radio"]');
      if (r) r.checked = true;
    });
  })();
</script>
{% endblock %}
